{"mode":"editor","version":"0.75.0","windowDimensions":{"x":1285,"y":22,"width":1024,"height":1357},"syntax":{"deserializer":"Syntax","grammarOverridesByPath":{}},"project":{"path":"/Users/tonyc/Desktop/Wonder-API-Accounts","buffers":[{"text":"class Api::PurchasesController < Api::ApiController\n  GOOGLE_PLAY_SUBSCRIPTION_PROVIDER = \"google_play_subs\"\n  GOOGLE_PLAY_INAPP_PROVIDER = \"google_play_inapp\"\n  DEBUG_SUBSCRIPTION_PROVIDER = \"debug\"\n  APPLE_SUBSCRIPTION_PROVIDER = \"apple\"\n\n  def create\n    receipt = nil\n\n    case params[:payment_provider]\n    when GOOGLE_PLAY_SUBSCRIPTION_PROVIDER\n      receipt = GooglePlayReceipt.new(receipt_params)\n    when GOOGLE_PLAY_INAPP_PROVIDER\n      receipt = GooglePlayInappReceipt.new(receipt_params)\n    when DEBUG_SUBSCRIPTION_PROVIDER\n      receipt = DebugReceipt.new(receipt_params)\n    when APPLE_SUBSCRIPTION_PROVIDER\n      receipt = AppleReceipt.new(receipt_params)\n    else\n      render json:  string_to_error_document(\"Unknown payment provider.\"), status: 422\n      return\n    end\n\n    if current_user.owns_product(receipt)\n      render json: {user: current_user.as_json}, status: 200\n    else\n      if receipt.valid?\n        receipt.save\n        purchase = Purchase.new(receipt: receipt)\n\n        if purchase.valid?\n          purchase.save!\n          current_user.purchases << purchase\n          current_user.save!\n          render json: {user: current_user.as_json}, status: 201\n        else\n          render json: purchase.to_error_document, status: 422\n        end\n      else\n        render json: receipt.to_error_document, status: 422\n      end\n    end\n  end\n\n  private\n  def receipt_params\n    params.require(:payment_provider)\n    receipt_params = params.require(:receipt)\n    receipt_params.permit(:token, :product_identifier, :apple_user_purchases_token)\n  end\nend\n","markers":{"markers":{"1":{"id":1,"range":[[15,4],[15,4]],"tailed":false,"reversed":true,"valid":true,"invalidate":"never","persistent":true,"properties":{"type":"selection","editorId":30,"goalBufferRange":null},"deserializer":"Marker"}},"deserializer":"MarkerManager"},"history":{"undoStack":[],"redoStack":[],"deserializer":"History"},"filePath":"/Users/tonyc/Desktop/Wonder-API-Accounts/app/controllers/api/purchases_controller.rb","modifiedWhenLastPersisted":false,"digestWhenLastPersisted":"209735e78244284aff81bee76b261820fa2f0e9e","deserializer":"TextBuffer"},{"text":"class DebugReceipt < Receipt\n  def get_product_identifier\n    return SUBSCRIPTION_PURCHASE_IDENTIFIER\n  end\n\n  def get_expiration_date\n    return 1.years.from_now\n  end\n\n  private\n\n  def validate_receipt_with_provider\n  end\nend","markers":{"markers":{"1":{"id":1,"range":[[0,0],[0,0]],"tailed":false,"reversed":false,"valid":true,"invalidate":"never","persistent":true,"properties":{"type":"selection","editorId":32},"deserializer":"Marker"}},"deserializer":"MarkerManager"},"history":{"undoStack":[],"redoStack":[],"deserializer":"History"},"filePath":"/Users/tonyc/Desktop/Wonder-API-Accounts/app/models/debug_receipt.rb","modifiedWhenLastPersisted":false,"digestWhenLastPersisted":"733b8ef698a0ee984e6c1e0a19ca5a3f3904edfa","deserializer":"TextBuffer"}],"deserializer":"Project"},"workspace":{"paneContainer":{"root":{"items":[{"id":30,"softTabs":true,"scrollTop":0,"scrollLeft":0,"displayBuffer":{"id":31,"softWrap":true,"editorWidthInChars":98,"tokenizedBuffer":{"bufferPath":"/Users/tonyc/Desktop/Wonder-API-Accounts/app/controllers/api/purchases_controller.rb","tabLength":2,"deserializer":"TokenizedBuffer"},"deserializer":"DisplayBuffer"},"deserializer":"Editor"},{"deserializer":"SettingsView","version":2,"activePanelName":"Themes","uri":"atom://config"},{"id":32,"softTabs":true,"scrollTop":0,"scrollLeft":0,"displayBuffer":{"id":33,"softWrap":true,"editorWidthInChars":98,"tokenizedBuffer":{"bufferPath":"/Users/tonyc/Desktop/Wonder-API-Accounts/app/models/debug_receipt.rb","tabLength":2,"deserializer":"TokenizedBuffer"},"deserializer":"DisplayBuffer"},"deserializer":"Editor"}],"activeItemUri":"atom://config","focused":true,"active":true,"deserializer":"Pane"},"deserializer":"PaneContainer"},"fullScreen":false,"deserializer":"Workspace"},"packageStates":{"fuzzy-finder":{"/Users/tonyc/Desktop/Wonder-API-Accounts/app/controllers/api/purchases_controller.rb":1395427579548,"/Users/tonyc/Desktop/Wonder-API-Accounts/app/models/debug_receipt.rb":1395427577929},"keybinding-resolver":{"attached":false},"metrics":{"sessionLength":1534377},"tree-view":{"directoryExpansionStates":{},"hasFocus":false,"attached":true,"scrollLeft":0,"scrollTop":0,"width":200}}}